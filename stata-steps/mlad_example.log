
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      18.0
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-STATA-PC        https://www.stata.com
                                   979-696-4600        stata@stata.com

Stata license: 15-user 4-core network perpetual
Serial number: 501806323575
  Licensed to: Severin Elvatun
               CRN

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased; see help
          set_maxvar.

. do "mlad_example.do" 

. // Load data
. use https://www.pclambert.net/data/rott3, clear
(Rotterdam breast cancer data (augmented with cause of death))

. 
. // Use stpm3 model to fit simple model in Stata
. // Variables
. //   -- hormon (factor variable) 
. //   -- age (natural spline)
. stpm3  i.hormon @ns(age,df(3)), scale(lncumhazard) df(4) 

Iteration 0:  Log likelihood = -2886.9797  
Iteration 1:  Log likelihood = -2884.0565  
Iteration 2:  Log likelihood = -2884.0429  
Iteration 3:  Log likelihood = -2884.0429  

                                                        Number of obs =  2,982
                                                        Wald chi2(4)  = 132.42
Log likelihood = -2884.0429                             Prob > chi2   = 0.0000

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
xb           |
      hormon |
        yes  |   .3731572   .0885452     4.21   0.000     .1996119    .5467026
 _ns_f1_age1 |  -3.142327   .8938032    -3.52   0.000    -4.894149   -1.390505
 _ns_f1_age2 |  -.9788548   .3796951    -2.58   0.010    -1.723043   -.2346661
 _ns_f1_age3 |  -2.199723   .3953551    -5.56   0.000    -2.974604   -1.424841
-------------+----------------------------------------------------------------
time         |
        _ns1 |  -25.52175   1.864219   -13.69   0.000    -29.17555   -21.86795
        _ns2 |   8.048509   .9963344     8.08   0.000     6.095729    10.00129
        _ns3 |  -1.016756   .0438515   -23.19   0.000    -1.102703   -.9308083
        _ns4 |  -.6569238   .0476898   -13.77   0.000     -.750394   -.5634536
       _cons |   .8747299   .1904223     4.59   0.000     .5015089    1.247951
------------------------------------------------------------------------------
Extended functions
 (1) @ns(age, df(3))

. 
. estimates store stpm3

. 
. // Here is a simple way to get initial values
. // fit exponential model & use least squares
. // I will use the spline variables created by stpm3 when I use mlad
. streg i.hormon _ns_f1_age1 _ns_f1_age2 _ns_f1_age3, dist(exp)

         Failure _d: osi==1
   Analysis time _t: os/12
  Exit on or before: time 10*12
        ID variable: pid

Iteration 0:  Log likelihood = -3022.1979  
Iteration 1:  Log likelihood = -2977.5856  
Iteration 2:  Log likelihood =  -2967.277  
Iteration 3:  Log likelihood = -2967.2473  
Iteration 4:  Log likelihood = -2967.2473  

Exponential PH regression

No. of subjects =       2,982                           Number of obs =  2,982
No. of failures =       1,171
Time at risk    = 20,002.4244
                                                        LR chi2(4)    = 109.90
Log likelihood = -2967.2473                             Prob > chi2   = 0.0000

------------------------------------------------------------------------------
          _t | Haz. ratio   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
      hormon |
        yes  |   1.424495   .1256015     4.01   0.000     1.198417    1.693221
 _ns_f1_age1 |   .0509612   .0453617    -3.34   0.001     .0089036     .291684
 _ns_f1_age2 |   .3769882   .1429753    -2.57   0.010     .1792684    .7927781
 _ns_f1_age3 |   .1230702   .0483402    -5.33   0.000     .0569919    .2657618
       _cons |   .2219702   .0417761    -8.00   0.000     .1534947    .3209933
------------------------------------------------------------------------------
Note: _cons estimates baseline hazard.

. 
. predict surv, surv

. 
. gen logcumH = log(-log(surv))

. 
. // Store inital values
. matrix b_init = e(b)

. 
. // mlad is an alternative optimizer in Stata
. // It calls Python and most calculations are performed within Python
. // mlad requires a Python file to define the log-likelhood
. // Fit model using mlad
. // need to supply the two python files
. // Setup two equations as stpm3
. //   -- xb equation is for covariates effects
. //   -- time equation is for effect of time
. // Also the event indicator (_d) and derivatives (_dns1 _dns2 _dns3 _dns4) of
. // the spline variables are needed
. 
. global dnsvars _dns1 _dns2 _dns3 _dns4

. 
. mlad (xb:   = i.hormon _ns_f1_age1 _ns_f1_age2 _ns_f1_age3, nocons ) ///
>      (time: = _ns1 _ns2 _ns3 _ns4),                                  ///
>       othervars(_d _dns1 _dns2 _dns3 _dns4)                          ///
>       pysetup(fpm_setup)                                             ///
>       llfile(fpm_hazard_ll)                                          ///
>       init(b_init) search(off)                                                  
initial vector: extra parameter _t:0b.hormon found
specify skip option if necessary
r(111);

end of do-file
r(111);
